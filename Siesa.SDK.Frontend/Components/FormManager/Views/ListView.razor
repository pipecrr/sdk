@using SDK.Components.Visualization
@using Siesa.SDK.Frontend.Components.FormManager.Fields
@using Siesa.SDK.Entities;
@using Siesa.SDK.Frontend.Components.Visualization
@if (ErrorMsg != "")
{
    <label>@ErrorMsg</label>
}
else
{

    <RadzenDataGrid AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
    FilterMode="FilterMode.Advanced" AllowPaging="true" PageSize="ListViewModel.Paging.PageSize"
    PagerHorizontalAlign="HorizontalAlign.Center" AllowSorting="true" Data="@data" TItem="object" IsLoading="@Loading"
    @ref="@_gridRef" Count="@count" LoadData="@LoadData" ShowPagingSummary="true"
    PageSizeOptions="ListViewModel.Paging.AllowedPageSizes" @key="needUpdate">
        <Columns>
            <RadzenDataGridColumn TItem="object" Title="Acciones" Width="100px" Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
                
                    <HeaderTemplate>
                        @if(IsSubpanel){
                        <span
                            class="oi oi-plus cursor-pointer" @onclick="() => GoToCreate()"></span>
                        }else{
                            <span><ResourceViewer ResourceTag="Generic.Actions" /></span>
                        }
                    </HeaderTemplate>
               
                <Template Context="data">
                    <div class="action-buttons">
                        <button class="btn btn-link grid-btn-link" @onclick="() => GoToEdit(((IBaseSDK)data).GetRowid())"><span
                            class="oi oi-pencil"></span></button>
                        
                        @if(IsSubpanel){
                            <button class="btn btn-link grid-btn-link" @onclick="() => GoToDelete(((IBaseSDK)data).GetRowid(), data.ToString())"><span
                            class="oi oi-circle-x" style="color:red"></span></button>
                            
                        }
                        @* <button class="btn btn-link grid-btn-link"
                        @onclick="() => GoToDetail(((BaseSDK<>)data).Rowid)"><span class="oi oi-eye"></span></button> *@
                    </div>
                </Template>
            </RadzenDataGridColumn>
            @foreach (var field in ListViewModel.Fields)
            {
                var fieldName = field.Name;
                if (fieldName.StartsWith("BaseObj."))
                {
                    fieldName = fieldName.Substring(8);
                }
                var columnType = typeof(string);
                switch (field.FieldType)
                {
                    case FieldTypes.CharField:
                    case FieldTypes.TextField:
                    case FieldTypes.EntityField:
                        break;
                    case FieldTypes.DateField:
                    case FieldTypes.DateTimeField:
                        columnType = typeof(DateTime);
                        break;
                    case FieldTypes.DecimalField:
                    case FieldTypes.IntegerField:
                        columnType = typeof(int);
                        break;
                    case FieldTypes.BooleanField:
                        columnType = typeof(bool);
                        break;

                    default:
                        break;

                        //default
                }
                

                if(field.Name == ListViewModel.LinkTo)
                {
                    <RadzenDataGridColumn Property="@fieldName" TItem="object" Title="@field.Label" Type="@columnType">
                        <Template Context="data">
                            @if(OnClickDetail != null){
                                <a href="#" @onclick="() => GoToDetail(((IBaseSDK)data).GetRowid())" @onclick:preventDefault>@data</a>
                            }else{
                                <a href="/@BusinessName/detail/@(((IBaseSDK)data).GetRowid())/">@data</a>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                }else{
                    if(columnType == typeof(bool)){
                        <RadzenDataGridColumn Property="@fieldName" TItem="object" Title="@field.Label" Type="@columnType" TextAlign="TextAlign.Center" >
                            <Template Context="data">
                                <input type="checkbox" checked="@(data.GetType().GetProperty(fieldName).GetValue(data))" disabled />
                            </Template>
                        </RadzenDataGridColumn>

                    }else{
                        <RadzenDataGridColumn Property="@fieldName" TItem="object" Title="@field.Label" Type="@columnType" />
                    }
                    
                }
            }
        </Columns>
    </RadzenDataGrid>
    @if(SetTopBar)
    {
        <PageTitle><ResourceViewer ResourceTag="@($"{BusinessName}.Plural")" /></PageTitle>
        <SetTopBar>
            <TopBarTitle><ResourceViewer ResourceTag="@($"{BusinessName}.Plural")" /></TopBarTitle>
            <TopBarButtons>
                <SDKButton RenderStyle="SDKButtonRenderStyle.Primary" RenderStyleMode="SDKButtonRenderStyleMode.Text"
                Click="GoToCreate" ResourceTag="Generic.ActionCreate" />
                @foreach (var btn in ListViewModel.Buttons)
                {
                    <SDKButton RenderStyle="@btn.RenderStyle" RenderStyleMode="SDKButtonRenderStyleMode.Text" Click="@(()=> { OnClickCustomButton(@btn); })" ResourceTag="@btn.ResourceTag" />
                }
            </TopBarButtons>
        </SetTopBar>
    }
}