@using Siesa.SDK.Frontend.Components.Fields
@using Siesa.SDK.Frontend.Components.Visualization
@using Siesa.SDK.Components.Visualization
@using Siesa.SDK.Frontend.Services
@*using Siesa.MasterBackend.Business.Frontend.Components.UserComponent.Modal
@using Siesa.MasterBackend.Business.Frontend.Components.UserComponent.Main.FixedButton
@using Siesa.MasterBackend.Business.Frontend.Utils*@

@inject SDKDialogService SDKDialogService

<div class="row whcm_row">
    @* 1er cuadro *@
    <div class="col-12">
        <div class="row whcm_row">
            <div class="col-xl-6 col-lg-8 col-md-7 col-sm-8 col-12 d-flex form-group">
                <div class="w-100">
                    <span class="col-form-label col-form-label-sm font-weight-bold">
                        <SDKLabel
                            ResourceTag="BLUser.Plural"
                            CssClass="mb-0"
                        />
                    </span>
                    <SDKEntityField
                        BaseObj="@this"
                        FieldName="FieldRelated"
                        @ref="_sdkEntityFieldRef"
                        IsMultiple="true"
                        RelatedBusiness="@RelatedBusiness"
                        Filters="@EntityFieldFilters"
                    />
                </div>
                <div class="d-flex align-items-end ml-1">
                    <SDKButton
                        ResourceTag="Multiseleccion"
                        IconCssClass="fa-solid fa-list-check"
                        RenderStyle="SDKButtonRenderStyle.Light"
                        CssClass="btn_multiselect"
                        Click="@OpenModal"
                    />
                </div>
            </div>
            <div class="col-xl-3 col-lg-4 col-md-5 col-sm-4 col-12 d-flex align-items-end form-group">
                <SDKButton
                    ResourceTag="@AddButtonResourceTag"
                    RenderStyle="SDKButtonRenderStyle.Primary"
                    Click="@AddItem"
                />
            </div>
        </div>
    </div>
    @* 2do cuadro *@
    <div class="col-12 form-group">
        <span class="col-form-label col-form-label-sm font-weight-bold">
            <SDKLabel
                ResourceTag="@ListResourceTag"
                CssClass="mb-0"
            />
        </span>
        @if(RowidRecordsRelated?.Count > 0 && ConstantFilters?.Count > 0)
        {
            <ListView
                @ref="ListViewRef"
                IsMultiple="true"
                BusinessObj=@BusinessRelated
                BusinessName="@RelatedBusiness"
                SetTopBar="false"
                AllowCreate="false"
                AllowEdit="false"
                AllowDelete="false"
                AllowDetail="false"
                ShowSearchForm="false"
                ConstantFilters="@ConstantFilters"
                OnSelectedRow="@OnSelectRow"
            />

            <SDKFixedButtonManyToMany
                @ref="ComponentFixedButtonRef"
                ResourceTag=@RemoveButtonResourceTag
                OnCustomClick=@FixedClick
                ShowButton="@ShowButtonRemove"
            />
        }else
        {
            <div class="col-12 text-center font_color_primary_dark pt-3 pb-0">
                <SDKIcon Name="fa-circle-info" IconSize="fa-3x" />
                <p class="mt-3 mb-0 font_size_087">
                    <ResourceViewer
                        ResourceTag="@EmptyUsersResourceTag"
                    />
                </p>
            </div>
        }
    </div>
</div>

@code
{
    public async Task OpenModal()
    {
        await SDKDialogService.ShowCustomDialog(
            ds =>@<SDKModalManyToMany
                        Business=@BusinessRelated
                        RowidRecordsRelated=@RowidRecordsRelated
                        ItemsSelected=@ItemsSelected
                        SDKManyToManySelectorRef=@this
                    />,
            width:"80%",
            ResourceTag:"Custom.BLUser.MultiselectMessage"
        );
    }

    public void CloseModal()
    {
        SDKDialogService.Close();
        _ = RefreshListView();
    }
}