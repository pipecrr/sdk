@using Microsoft.AspNetCore.Components.Forms
@using Siesa.SDK.Frontend.Components
@using Siesa.SDK.Frontend.Components.Visualization
@using Siesa.SDK.Shared.Application
@using Microsoft.Extensions.DependencyInjection
@using Siesa.SDK.Shared.Services
@using Siesa.SDK.Shared.Utilities
@using Microsoft.AspNetCore.Http
@using System.IO
@using Siesa.SDK.Shared.DTOS

@inherits SDKComponent

@inject IJSRuntime JSRuntime
@inject IBackendRouterService BackendRouterService
@inject IAuthenticationService AuthenticationService
@inject IServiceProvider ServiceProvider

<div class="file-upload-container">
    <div class="input-container">
        <InputFile OnChange="@_OnChange" multiple="@IsMultiple" style="width: 300px; height: 200px; " accept="@FilterType" @ref="_refinputFile"/>
    </div>
    <img @ref="previewImageElem" width="200" height="100" />
    <div class="file-upload-icon">
        <SDKIcon Name="fa-arrow-up-from-bracket" OnClick="@ClickIcon"></SDKIcon>
    </div>
</div>
@if(IsMultiple){
    <div class="container">
        <div class="row">
            @foreach (var url in _PreviewFiles)
            {
                <img class="@_col sdk-preview-multi" src="@url" >
            }
        </div>
    </div>
}

@code {

     public InputFile? _refinputFile;
    private ElementReference previewImageElem;

    private InputFileChangeEventArgs InputFile;
    [Parameter] public Action<InputFileChangeEventArgs> OnInputFile {get; set;}
    [Parameter] public bool IsMultiple {get; set;}

    [Parameter] public string FilterType {get; set;} = "image/*";

    [Parameter] public string CssClass {get; set;}

    [Parameter] public string BusinessName {get; set;}

    [Parameter] public int RowidAttachmentDetail {get; set;}
    [Parameter] public int RowidAttachmentRelationship {get; set;}
    [Parameter] public bool SaveBytes {get; set;} = false;
    [Parameter] public int MaxSize {get; set;} = 3000000;
    private string _col = "col-12";
    private List<IBrowserFile> _FilesSelected = new List<IBrowserFile>();
    private List<string> _PreviewFiles = new List<string>();

    private dynamic BusinessObj = null;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();  
    }
    
    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
    }

    private async Task GetPreviewFile()
    {
        if(_refinputFile != null)
        {
            await JSRuntime.InvokeVoidAsync("previewImage", _refinputFile!.Element, previewImageElem);
        }
        StateHasChanged();
    }
    private void ClickIcon()
    {
        JSRuntime.InvokeVoidAsync("clickInputFile", _refinputFile.Element);
    }
    private async Task GetPreviewFiles()
    {
        if(_refinputFile != null)
        {
            _PreviewFiles = await JSRuntime.InvokeAsync<List<string>>("getUrlsImage", _refinputFile!.Element);
        }
        StateHasChanged();
    }

    private async Task _OnChange(InputFileChangeEventArgs _InputFile)
    {
        if(_InputFile != null)
        {
            InputFile = _InputFile;
            if(IsMultiple){
                var files = InputFile.GetMultipleFiles();
                foreach (var itemFile in files)
                {
                    _FilesSelected.Add(itemFile);
                }
                await GetPreviewFiles();
                if(_FilesSelected.Count == 2){
                    _col = "col-6";
                }else if(_FilesSelected.Count >= 3){
                    _col = "col-4";
                }else{
                    _col = "col-12";
                }
            }else{
                await GetPreviewFile();
            }
            OnInputFile?.Invoke(_InputFile);
        }
    }

    public async Task SDKUploadFile()
    {
        await IntanceBusinessObj();

        if (BusinessObj == null)
        {
            return;
        }

        var files = IsMultiple ? InputFile.GetMultipleFiles() : new[] { InputFile.File };

        foreach (var itemFile in files)
        {
            var formFile = await ConvertToIFormFile(itemFile);
            var fileUploadDTO = new SDKFileUploadDTO();

            if(SaveBytes){
                fileUploadDTO = await BusinessObj.UploadSingleByte(formFile);
            }else{
                fileUploadDTO = await BusinessObj.UploadSingle(formFile);
            }

            if (fileUploadDTO != null)
            {
                fileUploadDTO.RowidAttachment = RowidAttachmentRelationship;
                dynamic saveFile;

                if (RowidAttachmentDetail > 0)
                {
                    saveFile = await BusinessObj.SaveAttachmentDetail(fileUploadDTO, RowidAttachmentDetail);
                }
                else
                {
                    saveFile = await BusinessObj.SaveAttachmentDetail(fileUploadDTO);
                    if(!IsMultiple){
                        RowidAttachmentDetail = saveFile;
                    }
                }
            }
        }
    }

    private async Task<IFormFile> ConvertToIFormFile(IBrowserFile browserFile)
    {
        var ms = new MemoryStream();
        if(browserFile.Size > MaxSize){
            throw new Exception("El archivo es demasiado grande");
        }

        await browserFile.OpenReadStream(maxAllowedSize: MaxSize).CopyToAsync(ms);
        
        var file = new FormFile(ms, 0, ms.Length, null, browserFile.Name)
        {
            Headers = new HeaderDictionary(),
            ContentType = (browserFile.ContentType == "" ? "application/octet-stream": browserFile.ContentType)
        };

        return file;
    }
    

    private async Task IntanceBusinessObj()
    {
        if (ServiceProvider != null)
        {
            var businessModel = BackendRouterService.GetSDKBusinessModel(BusinessName, null);
            if (businessModel != null)
            {
                BusinessObj = ActivatorUtilities.CreateInstance(ServiceProvider,
                Utilities.SearchType($"{businessModel.Namespace}.{businessModel.Name}", true));
            }
        }
    }
}